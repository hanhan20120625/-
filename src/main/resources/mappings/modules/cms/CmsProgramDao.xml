<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.msframe.modules.cms.dao.CmsProgramDao">

    <sql id="cmsProgramColumns">
		a.id AS "id",
		a.cp_contentid AS "cpContentid",
		a.sp_id AS "spId.id",
		a.name AS "name",
		a.original_name AS "originalName",
		a.sp_categoryid AS "spCategoryid",
		a.sort_name AS "sortName",
		a.search_name AS "searchName",
		a.genre AS "genre",
		a.lang_id AS "langId",
		a.region_id AS "regionId",
		a.type_id AS "typeId",
		a.tag_id AS "tagId",
		a.release_year AS "releaseYear",
		a.org_air_date AS "orgAirDate",
		a.licensing_window_start AS "licensingWindowStart",
		a.licensing_window_end AS "licensingWindowEnd",
		a.display_as_new AS "displayAsNew",
		a.display_as_last_chance AS "displayAsLastChance",
		a.macro_vision AS "macroVision",
		a.description AS "description",
		a.price_taxin AS "priceTaxin",
		a.source_type AS "sourceType",
		a.series_flag AS "seriesFlag",
		a.total_episode AS "totalEpisode",
		a.key_word AS "keyWord",
		a.view_point AS "viewPoint",
		a.star_level AS "starLevel",
		a.rating AS "rating",
		a.awards AS "awards",
		a.length AS "length",
		a.sync_state AS "syncState",
		a.cms_state AS "cmsState",

		a.hbigpic AS "hBigPic",
		a.hsmallpic AS "hSmallPic",
		a.vbigpic AS "vBigPic",
		a.vsmallpic AS "vSmallPic",
		a.squarepic AS "squarePic",
		a.picurl AS "picUrl",

		a.status AS "status",
		a.sort AS "sort",
		a.create_by AS "createBy.id",
		a.create_date AS "createDate",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.del_flag AS "delFlag",
		a.remarks AS "remarks",
		a.remark1 AS "remark1",
		a.show_type AS "showType",

		sp.name AS "spId.name"
	</sql>

    <sql id="cmsProgramJoins">
		LEFT JOIN cms_sp sp ON sp.id = a.sp_id
		LEFT JOIN cms_program_category programCategory ON  programCategory.program_id = a.id
	</sql>


    <select id="get" resultType="CmsProgram">
        SELECT
        <include refid="cmsProgramColumns"/>
        FROM cms_program a
        LEFT JOIN cms_sp sp ON sp.id = a.sp_id
        WHERE a.id = #{id}
    </select>

    <select id="findList" resultType="CmsProgram">
        SELECT DISTINCT
        <include refid="cmsProgramColumns"/>
        FROM cms_program a
        <include refid="cmsProgramJoins"/>
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
            <if test="name != null and name != ''">
                AND a.name LIKE
                <if test="dbName == 'oracle'">'%'||#{name}||'%'</if>
                <if test="dbName == 'mssql'">'%'+#{name}+'%'</if>
                <if test="dbName == 'mysql'">concat('%',#{name},'%')</if>
            </if>
            <if test="licensingWindowStart != null and licensingWindowStart != ''">
                AND a.licensing_window_start = #{licensingWindowStart}
            </if>
            <if test="licensingWindowEnd != null and licensingWindowEnd != ''">
                AND a.licensing_window_end = #{licensingWindowEnd}
            </if>

            <if test="seriesFlag !=null and seriesFlag !=''">
                AND a.series_flag = #{seriesFlag}
            </if>

            <if test="cmsCategoryVo !=null and cmsCategoryVo !='' and cmsCategoryVo.id != null and cmsCategoryVo.id !=''">
                AND programCategory.category_id = #{cmsCategoryVo.id}
            </if>

            <if test="tagId !=null and tagId !=''">
                AND a.tag_id LIKE
                <if test="dbName == 'oracle'">'%'||#{tagId}||'%'</if>
                <if test="dbName == 'mssql'">'%'+#{tagId}+'%'</if>
                <if test="dbName == 'mysql'">concat('%',#{tagId},'%')</if>
            </if>

            <if test="totalEpisode != null and totalEpisode != ''">
                AND a.total_episode = #{totalEpisode}
            </if>

            <if test="status != null and status != '' or status == 0">
                AND a.status = #{status}
            </if>

        </where>
        <choose>
            <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                ORDER BY ${page.orderBy}
            </when>
            <otherwise>
                ORDER BY a.sort DESC
            </otherwise>
        </choose>
    </select>

    <select id="findAllList" resultType="CmsProgram">
        SELECT
        <include refid="cmsProgramColumns"/>
        FROM cms_program a
        <include refid="cmsProgramJoins"/>
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
        </where>
        <choose>
            <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                ORDER BY ${page.orderBy}
            </when>
            <otherwise>
                ORDER BY a.sort ASC
            </otherwise>
        </choose>
    </select>

    <insert id="insert">
		INSERT INTO cms_program(
			id,
			cp_contentid,
			sp_id,
			name,
			original_name,
			sp_categoryid,
			sort_name,
			search_name,
			genre,
			lang_id,
			region_id,
			type_id,
			tag_id,
			release_year,
			org_air_date,
			licensing_window_start,
			licensing_window_end,
			display_as_new,
			display_as_last_chance,
			macro_vision,
			description,
			price_taxin,
			source_type,
			series_flag,
			total_episode,
			key_word,
			view_point,
			star_level,
			rating,
			awards,
			length,
			sync_state,
			cms_state,

            hbigpic,
            hsmallpic,
            vbigpic,
            vsmallpic,
            squarepic,
            picurl,

			status,
			sort,
			create_by,
			create_date,
			update_by,
			update_date,
			del_flag,
			remarks,
			remark1,
			show_type
		) VALUES (
			#{id},
			#{cpContentid},
			#{spId.id},
			#{name},
			#{originalName},
			#{spCategoryid},
			#{sortName},
			#{searchName},
			#{genre},
			#{langId},
			#{regionId},
			#{typeId},
			#{tagId},
			#{releaseYear},
			#{orgAirDate},
			#{licensingWindowStart},
			#{licensingWindowEnd},
			#{displayAsNew},
			#{displayAsLastChance},
			#{macroVision},
			#{description},
			#{priceTaxin},
			#{sourceType},
			#{seriesFlag},
			#{totalEpisode},
			#{keyWord},
			#{viewPoint},
			#{starLevel},
			#{rating},
			#{awards},
			#{length},
			#{syncState},
			#{cmsState},

			#{hBigPic},
			#{hSmallPic},
			#{vBigPic},
			#{vSmallPic},
			#{squarePic},
			#{picUrl},

			#{status},
			#{sort},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{delFlag},
			#{remarks},
			#{remark1},
			#{showType}
		)
	</insert>

    <update id="update">
		UPDATE cms_program SET 	
			cp_contentid = #{cpContentid},
			sp_id = #{spId.id},
			name = #{name},
			original_name = #{originalName},
			sp_categoryid = #{spCategoryid},
			sort_name = #{sortName},
			search_name = #{searchName},
			genre = #{genre},
			lang_id = #{langId},
			region_id = #{regionId},
			type_id = #{typeId},
			tag_id = #{tagId},
			release_year = #{releaseYear},
			org_air_date = #{orgAirDate},
			licensing_window_start = #{licensingWindowStart},
			licensing_window_end = #{licensingWindowEnd},
			display_as_new = #{displayAsNew},
			display_as_last_chance = #{displayAsLastChance},
			macro_vision = #{macroVision},
			description = #{description},
			price_taxin = #{priceTaxin},
			source_type = #{sourceType},
			series_flag = #{seriesFlag},
			total_episode = #{totalEpisode},
			key_word = #{keyWord},
			view_point = #{viewPoint},
			star_level = #{starLevel},
			rating = #{rating},
			awards = #{awards},
			length = #{length},
			sync_state = #{syncState},
			cms_state = #{cmsState},

			hbigpic = #{hBigPic},
			hsmallpic = #{hSmallPic},
			vbigpic = #{vBigPic},
			vsmallpic = #{vSmallPic},
			squarepic = #{squarePic},
			picurl = #{picUrl},

			status = #{status},
			sort = #{sort},
			update_by = #{updateBy.id},
			update_date = #{updateDate},
			remarks = #{remarks},
			remark1 = #{remark1},
			show_type = #{showType}
		WHERE id = #{id}
	</update>


    <!--物理删除-->
    <update id="delete">
		DELETE FROM cms_program
		WHERE id = #{id}
	</update>

    <!--逻辑删除-->
    <update id="deleteByLogic">
		UPDATE cms_program SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>


    <!-- 根据实体名称和字段名称和字段值获取唯一记录 -->
    <select id="findUniqueByProperty" resultType="CmsProgram" statementType="STATEMENT">
		select * FROM cms_program  where ${propertyName} = '${value}'
	</select>


    <!-- 排序功能 Begin -->
    <!-- 读取上一条数据 -->
    <select id="selectTopSort" resultType="java.lang.Long">
		SELECT a.sort FROM cms_program a
		<include refid="cmsProgramJoins"/>
		WHERE a.sort !=''
		<include refid="condition"/>
		ORDER BY a.sort ASC limit 0,1
	</select>

    <select id="selectPreviousSort" resultType="java.util.Map" parameterType="java.util.Map">
		SELECT a.id,a.sort FROM cms_program a
		<include refid="cmsProgramJoins"/>
		WHERE a.sort &gt; #{sort}
		<include refid="condition"/>
		ORDER BY a.sort ASC limit 0,1
    </select>

    <!-- 读取下一条数据 -->
    <select id="selectNextSort" resultType="java.util.Map" parameterType="java.util.Map">
		  SELECT a.id,a.sort FROM cms_program a
			<include refid="cmsProgramJoins"/>
		  WHERE a.sort &lt; #{sort}
		  <include refid="condition"/>
		  ORDER BY a.sort DESC limit 0,1
	</select>

    <!-- 修改当前数据的排序 -->
    <update id="updateSelfSort" parameterType="java.util.Map">
		UPDATE cms_program SET sort = #{sort} WHERE id = #{id}
		<include refid="condition"/>
	</update>

    <!-- 修改当前的上一条、下一条的排序数据 -->
    <update id="updateOtherSort" parameterType="java.util.Map">
		UPDATE cms_program SET sort = #{sort} WHERE  sort = #{origianlSort}
		<include refid="condition"/>
	</update>
    <!-- 排序功能 End -->

	<sql id="condition">
		<if test="name != null and name !=''">
			and name LIKE
			<if test="dbName == 'oracle'">'%'||#{name}||'%'</if>
			<if test="dbName == 'mssql'">'%'+#{name}+'%'</if>
			<if test="dbName == 'mysql'">concat('%',#{name},'%')</if>
		</if>
		<if test="cmsCategoryVoId !=null and cmsCategoryVoId !='' ">
			AND programCategory.category_id = #{cmsCategoryVoId}
		</if>
		<if test="seriesFlag !=null and seriesFlag !=''">
			AND series_flag = #{seriesFlag}
		</if>
		<if test="tagId != null and tagId !=''">
			AND a.tag_id = #{tagId}
		</if>
		<if test="totalEpisode != null and totalEpisode !=''">
			AND a.total_episode = #{totalEpisode}
		</if>
		<if test="status != null and status != ''">
			AND a.status = #{status}
		</if>
	</sql>
</mapper>